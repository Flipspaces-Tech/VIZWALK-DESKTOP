"use strict";(self.webpackChunkstreampixelsdkexample=self.webpackChunkstreampixelsdkexample||[]).push([[221],{221:(e,t,n)=>{n.r(t),n.d(t,{default:()=>h});var o=n(43),r=n(579);const i="https://script.google.com/macros/s/AKfycbxcVqr7exlAGvAVSh672rB_oG7FdL0W0ymkRb_6L7A8awu7gqYDInR_6FLczLNkpr0B/exec";function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return new URL(window.location.href).searchParams.get(e)||t}const s={connecting:a("msg1","Starting connection to Vizwalk server, please wait"),launching:a("msg2","Almost there, hold tight\u2014awesomeness loading"),finalizing:a("msg3","Sharpening pixels and buffing the details\u2026")},c=e=>{if("boolean"===typeof e)return e;if("number"===typeof e)return 0!==e;if("string"===typeof e){const t=e.trim().toLowerCase();return"true"===t||"1"===t||"yes"===t||"on"===t}return!!e};let l,d,u,p=null;async function v(e){const t=a("appId","").trim();if(t)return t;const n=await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new URL(e);let o,r;Object.entries(t).forEach(e=>{let[t,o]=e;void 0!==o&&null!==o&&""!==String(o).trim()&&n.searchParams.set(t,String(o))});try{o=await fetch(n.toString(),{method:"GET"})}catch(s){throw new Error("Network error to ".concat(n,": ").concat((null===s||void 0===s?void 0:s.message)||s))}try{const e=await o.clone().json();if(!o.ok||!1===(null===e||void 0===e?void 0:e.ok))throw new Error((null===e||void 0===e?void 0:e.error)||"HTTP ".concat(o.status));return e}catch(c){var i,a;throw r=await o.text().catch(()=>""),new Error("Expected JSON from Apps Script but got: ".concat((null===(i=r)||void 0===i?void 0:i.slice(0,300))||"(no body)"," (HTTP ").concat(null===(a=o)||void 0===a?void 0:a.status,")"))}}(i,{action:"getappid",build:e});if(null!==n&&void 0!==n&&n.appId&&"string"===typeof n.appId)return n.appId;throw new Error("No appId in response JSON")}function g(e){let{phase:t}=e;const n=o.useRef(null),[i,a]=o.useState(1),[c,l]=o.useState(1),d=o.useCallback(()=>{const e=n.current;if(!e||!e.naturalWidth||!e.naturalHeight)return;const t=window.innerWidth/window.innerHeight,o=e.naturalWidth/e.naturalHeight;a(t>o?t/o:1)},[]);o.useEffect(()=>{const e=()=>d();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[d]);if(!(!!t&&"ready"!==t))return null;return(0,r.jsxs)("div",{id:"sp-loader",style:{position:"fixed",inset:0,backgroundColor:"#000",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999,overflow:"hidden"},children:[(0,r.jsx)("img",{ref:n,src:"/gifs/conn.png",alt:t,onLoad:d,style:{width:"100%",height:"100%",transform:"scaleX(".concat(i,"),scaleY(").concat(c,")"),transformOrigin:"center",display:"block",userSelect:"none",pointerEvents:"none"}}),(0,r.jsx)("div",{style:{position:"fixed",top:"40px",left:"50px",maxWidth:"40vw",color:"#fff",padding:"10px 14px",borderRadius:"10px",fontSize:"24px",lineHeight:1.35,backdropFilter:"blur(4px)",WebkitBackdropFilter:"blur(4px)",boxShadow:"0 4px 18px rgba(0,0,0,0.35)"},children:s[t]||""})]})}function h(){const e=(0,o.useRef)(null),t=(0,o.useRef)(!1),s=(0,o.useRef)(!1),[h,f]=(0,o.useState)(!0),[w,y]=(0,o.useState)(!1),m=(0,o.useRef)(!1),b=(0,o.useRef)(!1),k=(0,o.useRef)(!1),[x,S]=(0,o.useState)("connecting"),[E,L]=(0,o.useState)(""),[R,U]=(0,o.useState)(""),C=(0,o.useMemo)(()=>a("build","Build"),[]),I=(0,o.useMemo)(()=>a("session","session-"+Date.now()),[]),j=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".png";try{const t=new URL(e),n=(t.pathname.split("/").pop()||"").split("?")[0]||"";if(n)return n}catch(n){}return"screenshot-".concat((new Date).toISOString().replace(/[:.]/g,"-")).concat(t)},O=e=>{if("string"!==typeof e)return!1;const t=e.trim();return!!/^https?:\/\//i.test(t)&&/\.(png|jpe?g|webp|gif)(\?.*)?$/i.test(t)},H=e=>/^http:\/\//i.test(String(e||"").trim()),T=(0,o.useCallback)(async(e,t)=>{const n=t||j(e);if(H(e))return(e=>{const t=new URL(i);t.searchParams.set("action","proxyget"),t.searchParams.set("url",e),t.searchParams.set("mode","redirect");const n=t.toString();console.log("Opening proxy:",n),window.open(n,"_blank","noopener,noreferrer")})(e),!0;try{const t=await fetch(e,{mode:"cors"});if(!t.ok)throw new Error("HTTP ".concat(t.status));const o=await t.blob(),r=document.createElement("a");return r.href=URL.createObjectURL(o),r.download=n,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(r.href),!0}catch(o){return console.warn("CORS/Fetch failed, opening URL directly:",o),window.open(e,"_blank","noopener,noreferrer"),!1}},[]),M=(0,o.useCallback)(async(e,t)=>{try{const n=await fetch(e);if(!n.ok)throw new Error("HTTP ".concat(n.status));const o=await n.blob(),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=t,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(r.href)}catch(n){console.warn("downloadDataUrl fallback open:",n),window.open(e,"_blank","noopener,noreferrer")}},[]),D=(0,o.useCallback)(t=>{if(!e.current||!t)return;e.current.innerHTML="",e.current.append(t);const n=e.current.querySelector("video");if(!n)return;n.muted=!0,n.autoplay=!0,n.playsInline=!0,n.tabIndex=0;const o=()=>{var e;return null===(e=n.play)||void 0===e?void 0:e.call(n).catch(()=>{})};o(),n.addEventListener("canplay",o,{once:!0});n.addEventListener("playing",()=>{S("ready");const e=document.getElementById("sp-loader");e&&(e.style.opacity="0",setTimeout(()=>e.remove(),380))},{once:!0});const r=()=>{n.muted=!1,n.removeEventListener("pointerdown",r)};n.addEventListener("pointerdown",r,{once:!0})},[]),z=(0,o.useCallback)(function(){var t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"keydown";const o=(null===(t=e.current)||void 0===t?void 0:t.querySelector("canvas, video"))||e.current||window;if(!o)return;const r=new KeyboardEvent(n,{key:"i",code:"KeyI",keyCode:73,which:73,bubbles:!0,cancelable:!0});o.dispatchEvent(r)},[e]),P=(0,o.useCallback)(()=>{var t;const n=(null===(t=e.current)||void 0===t?void 0:t.querySelector("canvas, video"))||e.current||document.body;if(!n||!n.getBoundingClientRect)return;const o=n.getBoundingClientRect(),r=o.left+o.width/2,i=o.top+o.height/2,a=e=>new MouseEvent(e,{bubbles:!0,cancelable:!0,clientX:r,clientY:i,button:0,buttons:1});n.dispatchEvent(a("mousedown")),n.dispatchEvent(a("mouseup")),n.dispatchEvent(a("click"))},[e]),A=(0,o.useCallback)(()=>{k.current||(k.current=!0,z("keydown"),z("keyup"),setTimeout(()=>{P(),setTimeout(()=>{z("keydown"),z("keyup"),k.current=!1},100)},200))},[z,P]),N=(0,o.useCallback)(async e=>{try{console.log("Received unreal message:",e);const s=async e=>{const t=(e||"").trim();t&&(H(t)?await async function(e,t,n){if(i)try{console.log("Uploading screenshot URL to Drive:",e);const r=new FormData;r.append("action","saveScreenshotUrl"),r.append("buildName",t),r.append("sessionId",n),r.append("imageUrl",e);const a=await fetch(i,{method:"POST",body:r});let s=null;try{s=await a.json()}catch(o){console.log("No JSON response (ok for now)",o)}return console.log("Drive upload result:",s),s}catch(r){return console.error("uploadScreenshotUrlToDrive error",r),null}}(t,C,I):await T(t,j(t)))};if("string"===typeof e){if(O(e))return void await s(e);try{e=JSON.parse(e)}catch(a){return}}const l=e;if(!l||"object"!==typeof l)return;if(Object.prototype.hasOwnProperty.call(l,"showMouseCursor")){var t;const e=c(l.showMouseCursor);return f(e),null!==(t=u)&&void 0!==t&&t.toggleHoveringMouse?u.toggleHoveringMouse(e):p=e,void(!1===e&&(m.current?A():b.current=!0))}if("showMouseCursor"===l.type){var n;const e=c(l.value);return f(e),void(null!==(n=u)&&void 0!==n&&n.toggleHoveringMouse?u.toggleHoveringMouse(e):p=e)}if("savedScreenshotUrl"===l.type||"string"===typeof l.savedScreenshotUrl||"string"===typeof l.value){const e="string"===typeof l.savedScreenshotUrl&&l.savedScreenshotUrl||"string"===typeof l.value&&l.value||"";if(e){const t=e.trim();if(O(t))await s(t);else{var o;const e=(null===(o=t.split("/").pop())||void 0===o?void 0:o.split("?")[0])||j(t);await M(t,e)}return}}if("string"===typeof l.savedScreenshotUrl){const e=l.savedScreenshotUrl.trim();if(O(e))await s(e);else{var r;const t=(null===(r=e.split("/").pop())||void 0===r?void 0:r.split("?")[0])||j(e);await M(e,t)}return}const d="string"===typeof l.url&&l.url||"string"===typeof l.link&&l.link||"string"===typeof l.s3Url&&l.s3Url||"string"===typeof l.ec2Url&&l.ec2Url||"string"===typeof l.http&&l.http||"string"===typeof l.value&&l.value||"";if(O(d))return void await s(d);let v=l.dataUrl||l.base64||l.imageData||l.png||l.jpg;if(v){"string"!==typeof v||v.startsWith("data:image/")||(v="data:image/png;base64,"+v);const e=l.filename||"screenshot-".concat((new Date).toISOString().replace(/[:.]/g,"-"),".png");if(await M(v,e),i&&i.startsWith("http")){const t=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({buildName:C,sessionId:I,imageDataUrl:v,stamp:e.replace(/\.png$/i,"")})}).then(e=>e.json()).catch(()=>null);if(null!==t&&void 0!==t&&t.ok&&!w){y(!0);const e="".concat(window.location.origin,"/gallery?build=").concat(encodeURIComponent(t.build||C),"&session=").concat(encodeURIComponent(t.session||I),"&folder=").concat(encodeURIComponent(t.folderId||""));window.open(e,"_blank","noopener,noreferrer")}else null!==t&&void 0!==t&&t.ok||console.warn("Drive upload failed (dataUrl path):",t)}return}}catch(s){console.error("handleResponseApp error:",s,e)}},[M,T,C,I,w,A]),W=(0,o.useCallback)(()=>{try{var t,n;null===(t=l)||void 0===t||null===(n=t.removeResponseEventListener)||void 0===n||n.call(t,"handle_responses",N)}catch(c){}try{var o,r,i;null===(o=d)||void 0===o||null===(r=o.stream)||void 0===r||null===(i=r.disconnect)||void 0===i||i.call(r)}catch(p){}try{var a,s;null===(a=l)||void 0===a||null===(s=a.disconnect)||void 0===s||s.call(a)}catch(v){}if(e.current)try{const t=e.current.querySelector("video");if(t){try{t.pause()}catch(g){}try{t.srcObject=null}catch(h){}t.removeAttribute("src");try{t.load()}catch(f){}}e.current.innerHTML=""}catch(w){}S("connecting"),l=void 0,d=void 0,u=void 0},[N]),_=(0,o.useCallback)(async()=>{if(t.current)return;t.current=!0,W();const{StreamPixelApplication:e}=await n.e(632).then(n.bind(n,632));let o="68d3987ed64e846388bcf314";try{o=await v(C)||o,U(o),L("")}catch(w){const e=(null===w||void 0===w?void 0:w.message)||String(w);console.warn("AppId resolve error:",e),L(e),U(o+" (fallback)")}const r=await e({AutoConnect:!0,appId:o,keyBoardInput:!0}),i=(null===r||void 0===r?void 0:r.appStream)||(null===r||void 0===r?void 0:r.app)||(null===r||void 0===r?void 0:r.stream),a=null===r||void 0===r?void 0:r.pixelStreaming,s=null===r||void 0===r?void 0:r.UIControl;if(!i||!a)return console.error("Unexpected SDK shape",r),void(t.current=!1);if(l=a,d=i,u=s,i.onWebRtcConnecting=()=>S("connecting"),i.onVideoInitialized=()=>S("launching"),i.onWebRtcConnected=()=>S("finalizing"),D(i.rootElement),i.onVideoInitialized=()=>{S("launching"),D(i.rootElement)},a.addResponseEventListener("handle_responses",N),console.log("added event listener to handle_responses"),null!==p){try{var c,g;null===(c=u)||void 0===c||null===(g=c.toggleHoveringMouse)||void 0===g||g.call(c,p)}catch(y){}try{f(!!p)}catch(m){}p=null}try{var h;await(null===(h=i.connect)||void 0===h?void 0:h.call(i))}catch(b){}t.current=!1},[D,N,W,C]),B=(0,o.useCallback)(()=>{f(e=>{var t,n;const o=!e;return null===(t=u)||void 0===t||null===(n=t.toggleHoveringMouse)||void 0===n||n.call(t,o),o})},[]);return(0,o.useEffect)(()=>{s.current=!0,_();const t=e=>{if("Digit0"===e.code&&e.altKey&&!e.repeat)return e.preventDefault(),e.stopPropagation(),void B();var t,n;"Backspace"!==e.code||e.repeat||(e.preventDefault(),e.stopPropagation(),f(!1),null===(t=u)||void 0===t||null===(n=t.toggleHoveringMouse)||void 0===n||n.call(t,!1))};window.addEventListener("keydown",t,{capture:!0});const n=e=>{e.isTrusted&&(m.current||(m.current=!0,b.current&&(b.current=!1,A())))};window.addEventListener("pointerdown",n,{capture:!0});const o=()=>{if("visible"===document.visibilityState){var t,n;const o=null===(t=e.current)||void 0===t?void 0:t.querySelector("video");null===o||void 0===o||null===(n=o.play)||void 0===n||n.call(o).catch(()=>{})}};document.addEventListener("visibilitychange",o);const r=e=>{e.persisted&&_()};window.addEventListener("pageshow",r);const i=()=>{W()};return window.addEventListener("pagehide",i),()=>{s.current=!1,window.removeEventListener("keydown",t,{capture:!0}),window.removeEventListener("pointerdown",n,{capture:!0}),document.removeEventListener("visibilitychange",o),window.removeEventListener("pageshow",r),window.removeEventListener("pagehide",i),W()}},[_,B,W,A]),(0,r.jsxs)("div",{className:"experience-page",children:[E&&(0,r.jsxs)("div",{style:{position:"fixed",top:10,left:10,right:10,zIndex:1e4,background:"#2b1e1e",color:"#ffb3b3",padding:"10px 14px",border:"1px solid #a44",borderRadius:8,fontSize:14},children:[(0,r.jsx)("b",{children:"AppId lookup failed:"})," ",E]}),R&&"ready"!==x&&(0,r.jsxs)("div",{style:{position:"fixed",top:"50px",right:"50px",zIndex:1e4,color:"white",padding:"8px 12px",borderRadius:8,fontSize:12,transition:"opacity 300ms ease",opacity:"ready"===x?0:1},children:["appId: ",R]}),(0,r.jsx)(g,{phase:x}),(0,r.jsx)("div",{id:"videoElement",ref:e,style:{backgroundColor:"#000",height:"100vh",position:"relative",willChange:"transform"}}),(0,r.jsx)("button",{onClick:B,style:{position:"fixed",bottom:20,right:20,zIndex:1e7,padding:"8px 12px",borderRadius:8,border:"1px solid #333",background:"#1a1a1a",color:"#fff",cursor:"pointer"},children:h?"Mouse Hover: ON (Alt+0)":"Mouse Hover: OFF (Alt+0)"})]})}}}]);
//# sourceMappingURL=221.0f3a05b5.chunk.js.map